# 手動テストガイド

## 概要

tumiki-recorderはテストフレームワークが設定されていないため、デプロイ前に手動テストを実施する必要があります。
このガイドでは、本番環境へのデプロイ前に実施すべきテスト項目を提供します。

## テスト環境

### ローカル開発環境
```bash
# ローカルサーバー起動
npm run dev

# アクセス先
http://localhost:8787
```

### モバイルテスト推奨
- **Android**: Chrome ブラウザ
- **iPhone**: Safari ブラウザ
- **ホーム画面に追加**してPWAとして動作確認

## テストカテゴリ

### 🔐 1. 認証テスト

#### ログイン成功
- [ ] 正しいユーザーIDとパスワードでログイン成功
- [ ] ログイン後、main.htmlにリダイレクトされる
- [ ] sessionStorageにauthToken, userId, userName, userRoleが保存される

#### ログイン失敗
- [ ] 間違ったパスワードで「ユーザーIDまたはパスワードが違います」エラー表示
- [ ] 存在しないユーザーIDで認証エラー
- [ ] 空のユーザーID/パスワードで適切なエラー表示

#### セッション管理
- [ ] 24時間後にトークン期限切れでログイン画面にリダイレクト
- [ ] ログアウト後、main.htmlにアクセスするとログイン画面にリダイレクト

---

### 📝 2. データ取得テスト

#### 利用者リスト
- [ ] 時間フィールドがある利用者のみ表示される
  - behaviorSupport.availableTime が設定されている
  - mobilitySupport.availableTime が設定されている
  - hospitalSupport.availableTime が設定されている
- [ ] 利用者名が正しく表示される
- [ ] ふりがなデータが正しく取得される

#### 支援員リスト
- [ ] 「株式会社ネクストステージ」所属の支援員のみ表示
- [ ] 特権ユーザー（亀野 浩、福澤 翔太）は全支援員を選択可能
- [ ] 一般ユーザーはログインユーザー名のみ選択可能

#### 残時間データ
- [ ] 当月の残時間データが正しく取得される
- [ ] 行動援護、移動支援、通院等介助の各残時間が表示される

---

### ✏️ 3. 記録入力テスト

#### フォーム入力
- [ ] 全必須項目が入力可能
  - 年月日
  - 開始時刻・終了時刻
  - 利用者名
  - 支援員1
  - 行き先（フリー入力）
  - 支援種別
  - 様子（10個のプリセットから選択）
- [ ] 支援員2は任意で空白選択可能
- [ ] 日付が今日と異なる場合、確認モーダルが表示される

#### データ保存
- [ ] 記録保存後、「保存完了」モーダルが表示される
- [ ] csv-schedulesコレクションにデータが保存される
- [ ] 保存後、フォームがリセットされる
- [ ] 時間計算が正しい（duration: HH:MM形式）

#### バリデーション
- [ ] 必須項目が未入力の場合、エラーメッセージ表示
- [ ] 開始時刻 > 終了時刻の場合、エラー表示

---

### 🌐 4. ネットワークエラーハンドリング

#### 認証エラー
- [ ] 401エラー時、自動的にログイン画面にリダイレクト
- [ ] sessionStorageがクリアされる
- [ ] 「セッションが期限切れです」メッセージ表示

#### サーバーエラー
- [ ] 500エラー時、適切なエラーメッセージ表示
- [ ] ユーザーが再試行できる

#### ネットワーク断絶
- [ ] オフライン時、Service Workerがキャッシュからデータ表示
- [ ] 「ネットワーク接続がありません」メッセージ表示（完全オフライン時）

---

### 📱 5. モバイル/PWA テスト

#### Service Worker
- [ ] 初回アクセス時にService Workerが登録される
- [ ] 2回目以降のアクセスでキャッシュが使用される
- [ ] オフライン時に静的ページが表示される

#### PWA機能
- [ ] ホーム画面に追加できる
- [ ] スタンドアロンモードで起動する
- [ ] アイコンが正しく表示される
- [ ] 縦向き（portrait）で固定される

#### モバイルUI
- [ ] タッチ操作が正常に動作する
- [ ] フォーム入力がスムーズ
- [ ] スクロールが正常に動作する
- [ ] キーボード表示時にレイアウトが崩れない

---

### ⚡ 6. パフォーマンステスト

#### キャッシュ動作
- [ ] 初回ロード後、10分以内の再ロードでFirestoreにアクセスしない
  - ブラウザ開発者ツールのNetworkタブで確認
  - ログに「キャッシュヒット」が表示される
- [ ] 10分経過後、再度Firestoreからデータ取得

#### ページロード時間
- [ ] 初回ロード: 3秒以内
- [ ] 2回目以降: 1秒以内（Service Workerキャッシュ）

#### レスポンス時間
- [ ] ログイン: 1秒以内
- [ ] データ取得: 1秒以内（キャッシュヒット時は即座）
- [ ] 記録保存: 2秒以内

---

### 🔒 7. セキュリティテスト

#### 認証
- [ ] 未認証でmain.htmlにアクセスするとログイン画面にリダイレクト
- [ ] JWTトークンなしでAPIにアクセスすると401エラー
- [ ] 期限切れトークンで401エラー

#### データアクセス
- [ ] 他ユーザーのデータにアクセスできない
- [ ] パスワードハッシュがレスポンスに含まれない

---

## テスト実施手順

### 1. ローカルテスト（デプロイ前）

```bash
# ローカルサーバー起動
npm run dev

# ブラウザで http://localhost:8787 にアクセス
# 上記のテスト項目を順番に実施
```

### 2. 本番環境テスト（デプロイ後）

```bash
# 本番デプロイ
npm run deploy

# デプロイ後のURLにアクセス
# モバイルデバイスでテスト
# PWA機能をテスト
```

### 3. クロスブラウザテスト

#### デスクトップ
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

#### モバイル
- [ ] Android Chrome
- [ ] iPhone Safari

---

## テストデータ

### テストユーザー（Firestoreに事前設定）

#### 管理者ユーザー
- ユーザーID: `admin`
- パスワード: `admin123` （実際の本番パスワードに置き換え）
- 権限: admin

#### 一般ユーザー
- ユーザーID: `test_user`
- パスワード: `test123`
- 権限: user

### テスト利用者
Firestoreの`users`コレクションから、時間フィールドがある利用者を使用

### テスト支援員
「株式会社ネクストステージ」所属の支援員を使用

---

## 既知の問題とワークアラウンド

### Service Workerが更新されない
**症状**: コード変更後も古いバージョンが表示される

**解決策**:
1. ブラウザ開発者ツールを開く
2. Application → Service Workers
3. 「Unregister」をクリック
4. ページを再読み込み

### キャッシュが更新されない
**症状**: データ変更後も古いデータが表示される

**解決策**:
- 10分待つ（TTL: 600秒）
- または、ブラウザを完全に閉じて再起動

---

## デプロイ前チェックリスト

### 環境変数
- [ ] FIREBASE_CLIENT_EMAIL が正しく設定されている
- [ ] FIREBASE_PRIVATE_KEY が正しく設定されている
- [ ] FIREBASE_PROJECT_ID が正しく設定されている
- [ ] JWT_SECRET が設定されている

### ビルド
- [ ] `npm run build:css` でCSSがコンパイルされる
- [ ] `style.css` が生成されている

### コード
- [ ] console.logが本番用に適切に設定されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] ハードコードされた認証情報がない

### ドキュメント
- [ ] README.mdが最新
- [ ] FIRESTORE_MIGRATION_COMPLETE.mdが最新
- [ ] 変更履歴が記録されている

---

## バグレポートフォーマット

バグを発見した場合、以下の形式で報告してください：

```
## バグ概要
[簡潔な説明]

## 再現手順
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

## 期待される動作
[正しい動作の説明]

## 実際の動作
[実際に起こった動作]

## 環境
- デバイス: [Android/iPhone/PC]
- ブラウザ: [Chrome/Safari/Firefox]
- OS: [iOS 17/Android 14/Windows 11]

## スクリーンショット
[可能であれば添付]

## エラーメッセージ
[ブラウザコンソールのエラー]
```

---

## テスト結果記録

### テスト実施日時
- [ ] YYYY-MM-DD HH:MM

### テスト実施者
- [ ] 名前: ________________

### テスト環境
- [ ] ローカル環境
- [ ] 本番環境

### テスト結果サマリー
- 合格: ____ / ____ 項目
- 失敗: ____ 項目
- スキップ: ____ 項目

### 備考
```
[テスト中に気づいた点や改善提案]
```

---

## 次のステップ

### テスト合格後
1. 本番環境にデプロイ
2. 本番環境で再度テスト
3. ユーザーに公開

### テスト失敗時
1. バグレポート作成
2. 修正実施
3. 再度テスト

---

## 自動テスト導入の検討

現在は手動テストですが、将来的に以下の自動テストフレームワークの導入を推奨します：

### 推奨テストフレームワーク

#### ユニットテスト
- **Vitest** - Cloudflare Workers対応
- **Jest** - JavaScript標準

#### E2Eテスト
- **Playwright** - モバイルブラウザ対応
- **Cypress** - フロントエンドテスト

#### 導入メリット
- テスト時間の短縮
- リグレッションの防止
- CI/CDパイプラインとの統合

---

## まとめ

このテストガイドを使用して、tumiki-recorderの品質を確保してください。

**重要**:
- デプロイ前に必ず全テスト項目を実施
- モバイルデバイスでのテストを優先
- バグは速やかに報告

ご質問やサポートが必要な場合は、開発チームにお問い合わせください。
