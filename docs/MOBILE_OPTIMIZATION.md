# モバイル最適化ガイド

## 概要

tumiki-recorderはスマートフォン（Android/iPhone）での使用を前提とした移動支援記録アプリケーションです。
モバイル環境特有の課題（不安定なネットワーク、オフライン状態、バッテリー消費など）に対応した最適化を実施しています。

## 実施した最適化

### 1. ✅ Service Workerによるオフライン対応

#### 新規ファイル: `service-worker.js`

**機能**:
- 静的アセット（HTML, CSS, JS, アイコン）のキャッシュ
- APIレスポンスのキャッシュ
- オフライン時のフォールバック

**キャッシュ戦略**:

| コンテンツタイプ | 戦略 | 説明 |
|-----------------|------|------|
| 静的アセット（HTML/CSS/JS） | Cache First | キャッシュ優先で高速読み込み |
| APIリクエスト（/api/*） | Network First | 最新データ優先、オフライン時はキャッシュ |

**オフライン時の動作**:
- 静的ページ: キャッシュから表示
- APIリクエスト: 前回キャッシュされたデータを表示
- 完全オフライン: 専用のオフラインページを表示

#### Service Worker登録
[index.html](index.html:257-270) にService Worker登録コードを追加。

### 2. ✅ Cloudflare Workersのメモリキャッシュ強化

#### キャッシュTTLの延長（モバイル向け調整）
- **変更前**: 5分間のキャッシュ
- **変更後**: 10分間のキャッシュ（`CacheTTL.MEDIUM`）

**理由**:
- モバイルネットワークは不安定なため、キャッシュ期間を長くして再取得頻度を削減
- 利用者・支援員リストは頻繁に変更されないため、長めのキャッシュが適切

#### Firestoreアクセスの最小化
```
シナリオ: 5人のスタッフが10分間に複数回アクセス

改善前:
- スタッフA: ログイン → Firestore 3回
- スタッフB: ログイン → Firestore 3回
- スタッフC: ログイン → Firestore 3回
- 合計: 15回以上のFirestoreアクセス

改善後:
- スタッフA: ログイン → Firestore 3回（キャッシュ作成）
- スタッフB: ログイン → Firestore 0回（キャッシュヒット）
- スタッフC: ログイン → Firestore 0回（キャッシュヒット）
- 合計: 3回のFirestoreアクセス（80%削減）
```

### 3. ✅ ネットワークエラーハンドリング強化

#### エラー検出の改善
- HTTPステータスコードの明示的チェック
- 401エラー時の自動ログアウト
- ネットワークタイムアウトの適切な処理

#### ユーザーへの明確な通知
- オフライン時: 「ネットワーク接続がありません」
- 認証エラー: 「セッションが期限切れです」
- サーバーエラー: 「サーバーエラーが発生しました」

### 4. ✅ PWA（Progressive Web App）最適化

#### 既存のPWA設定（確認済み）
- `manifest.json` - アプリメタデータ
- アイコン設定（192x192, 512x512など）
- `display: "standalone"` - ネイティブアプリのような表示
- `orientation: "portrait"` - 縦向き固定

#### ホーム画面に追加
Android/iPhoneでホーム画面に追加することで、ネイティブアプリのように使用可能。

## モバイル環境での利点

### 1. オフライン耐性
**シナリオ**: 移動中や地下など、ネットワークが不安定な場所
- Service Workerが静的アセットをキャッシュ
- 前回アクセス時のデータを表示可能
- オフライン時でも基本的なUIは表示

### 2. データ通信量の削減
**シナリオ**: モバイルデータ通信を使用する場合
- Cloudflare Workersのキャッシュでサーバーアクセス削減
- Service Workerのキャッシュでネットワークリクエスト削減
- 不要な再取得を防止

### 3. バッテリー消費の削減
**シナリオ**: 長時間の使用
- Firestoreアクセスの削減 → ネットワーク通信削減 → バッテリー節約
- キャッシュ活用で処理速度向上 → CPU使用率削減

### 4. 高速なページ読み込み
**シナリオ**: 記録入力時の快適性
- Service WorkerのCache First戦略で即座に表示
- Cloudflare Workersのキャッシュで即座にデータ取得

## モバイルブラウザ別の対応状況

### iOS Safari
- ✅ Service Worker対応（iOS 11.3以降）
- ✅ PWA対応（ホーム画面に追加）
- ✅ オフラインキャッシュ
- ⚠️ 制限事項: 50MBのキャッシュ制限

### Android Chrome
- ✅ Service Worker対応
- ✅ PWA対応（ホーム画面に追加）
- ✅ オフラインキャッシュ
- ✅ バックグラウンド同期（将来的に実装可能）

## 使用方法（エンドユーザー向け）

### ホーム画面に追加（推奨）

#### iPhone（iOS Safari）
1. Safariでアプリを開く
2. 画面下部の共有ボタン（□に↑）をタップ
3. 「ホーム画面に追加」を選択
4. 「追加」をタップ

#### Android（Chrome）
1. Chromeでアプリを開く
2. 画面右上のメニュー（⋮）をタップ
3. 「ホーム画面に追加」を選択
4. 「追加」をタップ

### オフライン時の使用
1. オンライン時に一度アプリにアクセス（キャッシュ作成）
2. オフライン時でも前回のデータが表示される
3. 新規データの送信はオンライン復帰後に実行

## テスト項目（開発者向け）

### Service Worker動作確認
- [ ] 初回アクセス時にService Workerが登録される
- [ ] 2回目以降のアクセスでキャッシュが使用される
- [ ] オフライン時にオフラインページが表示される
- [ ] オンライン復帰時に最新データが取得される

### モバイルネットワークテスト
- [ ] 4G/5G接続で正常に動作する
- [ ] Wi-Fi接続で正常に動作する
- [ ] 機内モードでキャッシュデータが表示される
- [ ] ネットワーク切り替え時にエラーが発生しない

### パフォーマンステスト
- [ ] ページ読み込み時間が3秒以内（初回）
- [ ] ページ読み込み時間が1秒以内（2回目以降）
- [ ] Firestoreアクセスが最小限（10分間で1回程度）

### PWAテスト
- [ ] ホーム画面に追加できる
- [ ] スタンドアロンモードで起動する
- [ ] アイコンが正しく表示される
- [ ] スプラッシュスクリーンが表示される（Android）

## トラブルシューティング

### Service Workerが登録されない
**原因**: HTTPSでないとService Workerは動作しない
**解決策**: Cloudflare WorkersはデフォルトでHTTPSなので問題なし

### キャッシュが更新されない
**原因**: Service Workerのバージョンが古い
**解決策**:
1. ブラウザの開発者ツールを開く
2. Application → Service Workers
3. 「Unregister」をクリック
4. ページを再読み込み

### オフライン時にデータが表示されない
**原因**: 一度もオンラインでアクセスしていない
**解決策**: オンライン時に一度アクセスしてキャッシュを作成

## 今後の拡張可能性

### バックグラウンド同期（Background Sync API）
オフライン時に記録したデータを、オンライン復帰時に自動的に同期する機能。
Androidでは利用可能、iOSでは未対応。

### プッシュ通知（Push API）
重要な通知をプッシュ通知で送信する機能。
管理者からのお知らせなどに活用可能。

### インデックスDB
大量のデータをローカルに保存する機能。
過去の記録をオフラインでも閲覧可能にする。

## まとめ

モバイル環境での信頼性とパフォーマンスを大幅に向上させました：

1. ✅ **オフライン対応** - Service Workerによるキャッシュ戦略
2. ✅ **ネットワーク最適化** - Firestoreアクセスを80%削減
3. ✅ **エラー耐性** - ネットワークエラー時の適切なハンドリング
4. ✅ **ユーザー体験** - 高速な読み込みと明確なフィードバック

これにより、移動中や不安定なネットワーク環境でも快適に使用できるアプリケーションになりました。
