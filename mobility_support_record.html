<!DOCTYPE html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ç§»å‹•æ”¯æ´è¨˜éŒ²è¡¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 py-4">
    <div class="w-full max-w-sm bg-white p-6 shadow-lg rounded-lg border border-gray-200 mx-auto py-4">
        <form id="recordForm" method="POST" action="https://script.google.com/macros/s/AKfycbzgBF7R6ZxbgFEYzFEYaN7HXigKOV0VK0Bmk-GWyyhBzchBiAQAuIPFZE_GnfwD-RAh/exec" target="_blank">
        <div class="border border-gray-400 p-2 text-center mb-6">
            <h1 class="text-xl font-bold tracking-widest">ç§»å‹•æ”¯æ´è¨˜éŒ²è¡¨</h1>
        </div>

        <!-- Date Inputs -->
        <div class="mb-6 flex items-center space-x-2 text-lg flex-wrap">
            <input list="years" id="year" name="year" class="w-24 border-b border-gray-400 text-center" placeholder="YYYY" required>
            <datalist id="years"></datalist>
            <span class="ml-1">å¹´</span>

            <input list="months" id="month" name="month" class="w-16 border-b border-gray-400 text-center" placeholder="MM" required>
            <datalist id="months"></datalist>
            <span class="ml-1">æœˆ</span>

            <input list="days" id="day" name="day" class="w-16 border-b border-gray-400 text-center" placeholder="DD" required>
            <datalist id="days"></datalist>
            <span class="ml-1">æ—¥</span>
        </div>

        <!-- Time Inputs -->
        <div class="mb-6 flex items-center space-x-4 text-lg flex-wrap">
            <input id="start-time" name="startTime" class="w-24 border-b border-gray-400 text-center" placeholder="é–‹å§‹æ™‚é–“" required>
            <span class="font-bold mx-2">~</span>
            <input id="end-time" name="endTime" class="w-24 border-b border-gray-400 text-center" placeholder="çµ‚äº†æ™‚é–“" required>
        </div>

        <!-- User Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="user-input">åˆ©ç”¨è€…</label>
            <input list="users" id="user-input" name="user" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="users">
                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </datalist>
        </div>

        <!-- Supporter 1 Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="supporter1-input">æ”¯æ´å“¡1</label>
            <input list="supporters" id="supporter1-input" name="supporter1" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="supporters">
                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </datalist>
        </div>

        <!-- Supporter 2 Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="supporter2-input">æ”¯æ´å“¡2</label>
            <input list="supporters" id="supporter2-input" name="supporter2" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2">
        </div>

        <!-- Destination Input -->
        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="destination-input">è¡Œãå…ˆ</label>
            <input list="destinations" id="destination-input" name="destination" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="destinations">
                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </datalist>
        </div>

        <div class="mb-2 flex flex-wrap items-center">
            <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="support-type-input">æ”¯æ´ç¨®åˆ¥</label>
            <input list="support-types" id="support-type-input" name="supportType" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
            <datalist id="support-types">
                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </datalist>
        </div>

        <div class="mt-4 pt-2">
            <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4">
                <p class="text-lg font-bold text-gray-900">åˆ©ç”¨è€…æ§˜ç¢ºèªæ¬„</p>
                <div class="flex items-center">
                    <input type="checkbox" id="check1" name="userCheck" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" required>
                    <label for="check1" class="ml-3 block text-lg font-bold text-gray-900">ä¸Šè¨˜å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚</label>
                </div>
                <p class="text-red-600 text-sm mt-2">â€»åˆ©ç”¨è€…æ§˜ã«ãƒã‚§ãƒƒã‚¯ã‚’ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div class="mb-2 flex flex-wrap items-center">
                <label class="block text-sm font-medium bg-gray-200 px-3 py-1.5 inline-block border border-gray-400 mr-2" for="appearance-input">æ§˜å­</label>
                <input list="appearances" id="appearance-input" name="appearance" class="mt-1 flex-1 border-b-2 border-gray-400 h-8 px-2" required>
                <datalist id="appearances">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </datalist>
            </div>
        </div>
        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mt-4">è¨˜éŒ²ã‚’é€ä¿¡</button>
        </form>
    </div>

    <script>
        console.log("Script loaded and running");

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function loadDataLists() {
            try {
                console.log("=== ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã‚’å–å¾—ä¸­... ===");
                
                // Google Apps Script ã® URLï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
                const dataUrl = 'https://script.google.com/macros/s/AKfycbzgBF7R6ZxbgFEYzFEYaN7HXigKOV0VK0Bmk-GWyyhBzchBiAQAuIPFZE_GnfwD-RAh/exec?action=getData';
                console.log("ãƒ‡ãƒ¼ã‚¿å–å¾—URL:", dataUrl);
                
                const response = await fetch(dataUrl);
                console.log("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:", response.status);
                console.log("ãƒ¬ã‚¹ãƒãƒ³ã‚¹OK:", response.ok);
                
                const responseText = await response.text();
                console.log("ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:", responseText);
                
                const data = JSON.parse(responseText);
                console.log("ãƒ‘ãƒ¼ã‚¹å¾Œãƒ‡ãƒ¼ã‚¿:", data);
                
                if (data.success) {
                    // å„ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    console.log("åˆ©ç”¨è€…æ•°:", data.users?.length || 0);
                    console.log("æ”¯æ´å“¡æ•°:", data.supporters?.length || 0);
                    console.log("è¡Œãå…ˆæ•°:", data.destinations?.length || 0);
                    console.log("æ§˜å­æ•°:", data.appearances?.length || 0);
                    
                    updateDatalist('users', data.users || []);
                    updateDatalist('supporters', data.supporters || []);
                    updateDatalist('destinations', data.destinations || []);
                    updateDatalist('support-types', data.supportTypes || []);
                    updateDatalist('appearances', data.appearances || []);
                    
                    console.log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ");
                } else {
                    console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", data.error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                    loadDefaultData();
                }
            } catch (error) {
                console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—:", error);
                console.error("ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:", error.message);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                loadDefaultData();
            }
        }

        // datalist ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateDatalist(datalistId, items) {
            console.log(`ğŸ“ ${datalistId} ã‚’æ›´æ–°ä¸­... ã‚¢ã‚¤ãƒ†ãƒ æ•°: ${items.length}`);
            const datalist = document.getElementById(datalistId);
            
            if (!datalist) {
                console.error(`âŒ datalist ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${datalistId}`);
                return;
            }
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            datalist.innerHTML = '';
            console.log(`ğŸ—‘ï¸ ${datalistId} ã®æ—¢å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
            
            // "-" ã‚’é™¤å¤–ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredItems = items.filter(item => item && item.toString().trim() !== '' && item.toString().trim() !== '-');
            
            // æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            filteredItems.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = item;
                datalist.appendChild(option);
                if (index < 3) { // æœ€åˆã®3ã¤ã ã‘ãƒ­ã‚°å‡ºåŠ›
                    console.log(`â• ${datalistId}[${index}]: ${item}`);
                }
            });
            
            console.log(`âœ… ${datalistId} ã®æ›´æ–°å®Œäº†ï¼ˆ${filteredItems.length}å€‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€${items.length - filteredItems.length}å€‹é™¤å¤–ï¼‰`);
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        function loadDefaultData() {
            console.log("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™");
            
            const defaultUsers = [
                "å¹³æ—æµå­", "ç©ºå±±ç´˜å­", "å±±ï¨‘å¤šæµ", "æ°´è°·å¤•ç¾å­", "å¡šåŸæ­©ç¾", "ä¸Šæ‘æ¢¨æ¡œ", 
                "å²©æœ¬å°è€¶å­", "æ¾¤æ‘å’Œæµ©", "å»£ç€¬ä¹…ç”·", "æ¸…æ°´å¥å¸", "ç”°ä¸­çœŸä¹Ÿ", "ä¸­è¥¿ä¿Šä¹Ÿ", 
                "æ£®æœ¬å¾¹", "å°æ³‰æ˜¥å¤«", "é•·é‡å´‡", "å‹ç”°é™½å­", "ä»Šäº•æµ©", "å‡ºæˆ¸å¸‚æœ—", 
                "å²¡ç”°æµ©å—£", "ä¸Šæ—èª ", "æºå·æ™§ä»‹", "ä¹…å±±å¤§", "æ¸¡é‚‰ä¸€å­", "å¡©è°·æ‹“ä¹Ÿ", 
                "è—¤æœ¬å’Œä¹Ÿ", "ä¸Šç”°æ²»", "ä»²è¥¿ç¾ç”±ç´€", "ç”°ä¸Šæ…¶ç¥", "æ¦æœ¬è‰¯å…", "åƒè‘‰ç¾æ²™ä»£", "è°ç”°çµµç¾å­"
            ];

            const defaultSupporters = [
                "äº€é‡ æµ©", "æ— æµç¾å­", "è¥¿æ‘ å­ä»", "å‡ºå£  èŒœè¦–", "æœ¨ä¸‹ è£•æ™ƒ", "å»£ç€¬ å„ª", 
                "æœ¨æ‘ å‡œ", "å¤åŸ çœŸå’²ä»£", "è—¤ç”° æ¢“å¹³", "å…¥æ±Ÿ éš†æµ©", "å’Œç”° çœŸç”±ç¾", "å’Œç”° éƒäºº", 
                "å— é‘‘æ†²", "æ£®å£  å½°", "å²©äº• æ³°å­", "ç›¸é¦¬ èŠ³å­", "å¥¥æ‘ ã•ã¤ã", "å¥¥æ‘ ç´˜å¹³", 
                "æ¾ä¸‹ ç´—å­£", "ä»Šè¥¿ å½©"
            ];

            const defaultDestinations = ["æ•£æ­©", "è²·ã„ç‰©", "å›³æ›¸é¤¨"];
            const defaultSupportTypes = ["ç§»å‹•æ”¯æ´", "è¡Œå‹•æ´è­·", "é€šé™¢ä»‹åŠ©"];
            const defaultAppearances = [
                "æ°—æŒã¡ãŒè‰¯ã•ãã†ã ã£ãŸ", "ç¬‘é¡”ãŒå¤šã„æ§˜å­ã ã£ãŸ", "å°‘ã—ç–²ã‚ŒãŸæ§˜å­ã ã£ãŸ", 
                "ã¾ãŸå¤–å‡ºã—ãŸã„ã¨è©±ã—ã¦ã„ãŸ", "å…ƒæ°—ãªæ§˜å­ã ã£ãŸ", "æ´»ç™ºã«å‹•ã‘ãŸ", 
                "å°‘ã—è½ã¡ç€ããŒãªã‹ã£ãŸ", "ä¸å®‰ãªè¡¨æƒ…ãŒè¦‹ãˆãŸ", "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤šã‹ã£ãŸ", "ç„¡å£ãªæ™‚é–“ãŒã‚ã£ãŸ"
            ];

            updateDatalist('users', defaultUsers);
            updateDatalist('supporters', defaultSupporters);
            updateDatalist('destinations', defaultDestinations);
            updateDatalist('support-types', defaultSupportTypes);
            updateDatalist('appearances', defaultAppearances);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
            await loadDataLists();
            
            // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†
            initializeDateOptions();
            setCurrentDate();
            setupTimeFormatting();
            setupFormSubmission();
        });

        // æ—¥ä»˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        function initializeDateOptions() {
            const currentYear = new Date().getFullYear();
            const yearsDatalist = document.getElementById('years');
            for (let i = 0; i < 5; i++) {
                const option = document.createElement('option');
                option.value = currentYear - i;
                yearsDatalist.appendChild(option);
            }

            const monthsDatalist = document.getElementById('months');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                monthsDatalist.appendChild(option);
            }

            const daysDatalist = document.getElementById('days');
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                daysDatalist.appendChild(option);
            }
        }

        // ç¾åœ¨ã®æ—¥ä»˜ã‚’è¨­å®š
        function setCurrentDate() {
            const now = new Date();
            document.getElementById('year').value = now.getFullYear();
            document.getElementById('month').value = now.getMonth() + 1;
            document.getElementById('day').value = now.getDate();
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®š
        function setupTimeFormatting() {
            function formatTime(event) {
                console.log("formatTime called for:", event.target.id);
                const inputElement = event.target;
                let value = inputElement.value.replace(/[^0-9]/g, '');

                if (value === '') {
                    inputElement.value = '';
                    return;
                }

                let hour, minute;

                if (value.length <= 2) {
                    hour = parseInt(value, 10);
                    minute = 0;
                } else {
                    minute = parseInt(value.slice(-2), 10);
                    hour = parseInt(value.slice(0, -2), 10);
                }

                hour = isNaN(hour) ? 0 : hour;
                minute = isNaN(minute) ? 0 : minute;

                if (hour > 23) {
                    hour = 23;
                }
                if (minute > 59) {
                    minute = 59;
                }

                const formattedHour = hour.toString();
                const formattedMinute = minute.toString().padStart(2, '0');
                inputElement.value = `${formattedHour}:${formattedMinute}`;
            }

            document.getElementById('start-time').addEventListener('blur', formatTime);
            document.getElementById('end-time').addEventListener('blur', formatTime);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡è¨­å®š
        function setupFormSubmission() {
            document.getElementById('recordForm').addEventListener('submit', function(event) {
                const formData = new FormData(event.target);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
                
                // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å–å¾—
                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const day = document.getElementById('day').value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                const user = document.getElementById('user-input').value;
                const supporter1 = document.getElementById('supporter1-input').value;
                const supporter2 = document.getElementById('supporter2-input').value;
                const destination = document.getElementById('destination-input').value;
                const supportType = document.getElementById('support-type-input').value;
                const appearance = document.getElementById('appearance-input').value;
                const userCheck = document.getElementById('check1').checked ? 'ã¯ã„' : 'ã„ã„ãˆ';
                
                // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
                const confirmMessage = `ä»¥ä¸‹ã®å†…å®¹ã§é€ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ

ğŸ“… æ—¥ä»˜: ${year}å¹´${month}æœˆ${day}æ—¥
â° æ™‚é–“: ${startTime} ï½ ${endTime}
ğŸ‘¤ åˆ©ç”¨è€…: ${user}
ğŸ‘¥ æ”¯æ´å“¡1: ${supporter1}
ğŸ‘¥ æ”¯æ´å“¡2: ${supporter2}
ğŸ“ è¡Œãå…ˆ: ${destination}
ğŸ·ï¸ æ”¯æ´ç¨®åˆ¥: ${supportType}
ğŸ˜Š æ§˜å­: ${appearance}
âœ… åˆ©ç”¨è€…æ§˜ç¢ºèª: ${userCheck}`;
                
                if (!confirm(confirmMessage)) {
                    event.preventDefault();
                    return false;
                }
            });
        }

        // ç©ºç™½è¡Œã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
        function hideEmptyRows(sheet, startRow, endRow) {
          const hiddenRows = [];
          
          try {
            console.log(`ç©ºç™½è¡Œãƒã‚§ãƒƒã‚¯: ${startRow}è¡Œç›®ï½${endRow}è¡Œç›®`);
            
            // å„è¡Œã‚’ãƒã‚§ãƒƒã‚¯
            for (let row = startRow; row <= endRow; row++) {
              // Aåˆ—ã®å€¤ã‚’å–å¾—
              const valueA = sheet.getRange(row, 1).getValue();
              
              // Aåˆ—ãŒç©ºç™½ã¾ãŸã¯ç©ºæ–‡å­—ã®å ´åˆ
              if (!valueA || valueA.toString().trim() === '') {
                // è¡Œã‚’éè¡¨ç¤ºã«ã™ã‚‹
                sheet.hideRows(row, 1);
                hiddenRows.push(row);
              }
            }
            
            console.log(`éè¡¨ç¤ºã«ã—ãŸè¡Œ: ${hiddenRows.length}è¡Œ`);
            return hiddenRows;
            
          } catch (error) {
            console.error('ç©ºç™½è¡Œéè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            return hiddenRows;
          }
        }
    </script>
</body></html>